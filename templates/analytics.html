{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Sales Analytics</h2>

    <!-- Filter Options -->
    <div class="d-flex justify-content-between mb-4">
        <div>
            <label for="time-filter" class="form-label">Select Time Period</label>
            <select id="time-filter" class="form-select" onchange="updateAnalytics()">
                <option value="all">All Time</option>
                <option value="week">Past Week</option>
                <option value="month">Past 30 Days</option>
            </select>
        </div>
    </div>

    <!-- Metrics -->
    <div class="row">
        <!-- Total Revenue -->
        <div class="col-md-4">
            <div class="card p-3 mb-4">
                <h5>Total Revenue</h5>
                <p id="total-revenue">$0.00</p>
            </div>
        </div>

        <!-- Fulfilled Orders -->
        <div class="col-md-4">
            <div class="card p-3 mb-4">
                <h5>Fulfilled Orders</h5>
                <p id="fulfilled-orders">0</p>
            </div>
        </div>

        <!-- Top 3 Best-Selling Products -->
        <div class="col-md-4">
            <div class="card p-3 mb-4">
                <h5>Top 3 Best-Selling Products</h5>
                <ul id="top-products">
                    <li>Loading...</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Sales Over Time Chart -->
    <div class="card p-4 mb-4">
        <h5>Sales Over Time</h5>
        <canvas id="sales-chart"></canvas>
        <p id="no-sales-data" class="text-muted mt-3">No sales data yet. Displaying daily sales.</p>
    </div>

    <!-- Low Stock Warning -->
    <div class="card p-4">
        <h5>Low Stock Warning</h5>
        <ul id="low-stock-warning">
            <li>No products are low in stock.</li>
        </ul>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Update analytics based on selected time period
    function updateAnalytics() {
        const period = document.getElementById('time-filter').value;
        fetch(`/analytics/data/${period}`)
            .then(response => response.json())
            .then(data => {
                // Update total revenue and fulfilled orders
                document.getElementById('total-revenue').textContent = `$${data.total_revenue.toFixed(2)}`;
                document.getElementById('fulfilled-orders').textContent = data.fulfilled_orders;

                // Update top 3 best-selling products
                const topProductsList = document.getElementById('top-products');
                topProductsList.innerHTML = '';
                if (data.top_products.length > 0) {
                    data.top_products.forEach(product => {
                        const li = document.createElement('li');
                        li.textContent = product.name;
                        topProductsList.appendChild(li);
                    });
                } else {
                    topProductsList.innerHTML = '<li>You donâ€™t have enough data yet.</li>';
                }

                // Update low stock warning
                const lowStockList = document.getElementById('low-stock-warning');
                lowStockList.innerHTML = '';
                if (data.low_stock.length > 0) {
                    data.low_stock.forEach(product => {
                        const li = document.createElement('li');
                        li.textContent = `${product.name} (Quantity: ${product.quantity})`;
                        lowStockList.appendChild(li);
                    });
                } else {
                    lowStockList.innerHTML = '<li>No products are low in stock.</li>';
                }

                // Update sales chart and handle missing data
                if (data.sales_over_time.length > 0) {
                    document.getElementById('no-sales-data').style.display = 'none';
                    updateSalesChart(data.sales_over_time);
                } else {
                    document.getElementById('no-sales-data').style.display = 'block';
                    updateSalesChart([{ date: 'No data', sales: 0 }]);  // Show an empty chart if no data
                }
            });
    }

    // Initialize sales chart with empty data
    let salesChart;

    function updateSalesChart(data) {
        const labels = data.map(item => item.date);
        const sales = data.map(item => item.sales);

        if (salesChart) {
            salesChart.destroy();
        }

        const ctx = document.getElementById('sales-chart').getContext('2d');
        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Sales Over Time',
                    data: sales,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    fill: true,
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Sales ($)'
                        }
                    }
                }
            }
        });
    }

    // Initialize page with default 'all time' data
    document.addEventListener('DOMContentLoaded', () => {
        updateAnalytics();
    });
</script>

{% endblock %}
